<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .navbar { background-color: #2c3e50; }
        .navbar-brand, .nav-link { color: white !important; }

        /* Room selection */
        #roomSelection {
            max-width: 500px;
            margin: 80px auto;
        }
        #roomSelection .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #roomSelection .card-header {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px;
        }

        /* Chat area */
        #chatArea { display: none; margin-top: 70px; }
        .sidebar {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            min-height: calc(100vh - 70px);
            border-radius: 0;
        }
        .sidebar h5 { border-bottom: 1px solid #4a6278; padding-bottom: 10px; }
        .sidebar .member { padding: 4px 0; font-size: 14px; }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #eee;
        }
        .message-bubble {
            background-color: white;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-bubble.own {
            background-color: #d4edda;
            margin-left: auto;
        }
        .message-bubble.bot {
            background-color: #cce5ff;
            margin: 0 auto 10px auto;
            text-align: center;
        }
        .message-bubble.private-msg {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        .message-bubble .sender {
            font-weight: bold;
            font-size: 13px;
            color: #2c3e50;
        }
        .message-bubble .time {
            font-size: 11px;
            color: #888;
        }
        .message-bubble .text {
            margin-top: 4px;
            word-wrap: break-word;
        }

        .chat-input {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        #typingIndicator {
            padding: 0 20px;
            font-size: 13px;
            color: #888;
            font-style: italic;
            height: 20px;
            background-color: #eee;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand fixed-top">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold">Chat App</span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="welcomeUser"></span>
                <button class="btn btn-outline-light btn-sm" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Room Selection -->
    <div id="roomSelection">
        <div class="card">
            <div class="card-header">
                <h4>Chat App</h4>
            </div>
            <div class="card-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">Username</label>
                    <input type="text" class="form-control" id="displayUsername" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Room</label>
                    <select class="form-select" id="roomSelect">
                        <option value="devops">DevOps</option>
                        <option value="cloud computing">Cloud Computing</option>
                        <option value="covid19">COVID-19</option>
                        <option value="sports">Sports</option>
                        <option value="nodeJS">NodeJS</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100" id="joinRoomBtn"
                    style="background-color:#2c3e50; border-color:#2c3e50;">
                    Join Chat Room
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chatArea" class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 p-0">
                <div class="sidebar">
                    <h5>Room name: <span id="currentRoom"></span></h5>
                    <h6>Members:</h6>
                    <div id="membersList"></div>
                    <hr style="border-color:#4a6278;">
                    <h6>Private Message</h6>
                    <select class="form-select form-select-sm mb-2" id="privateUserSelect">
                        <option value="">Select user...</option>
                    </select>
                    <button class="btn btn-warning btn-sm w-100 mt-3" id="leaveRoomBtn">Leave Room</button>
                </div>
            </div>
            <!-- Chat -->
            <div class="col-md-9 col-lg-10 p-0">
                <div class="chat-container">
                    <div class="messages" id="messages"></div>
                    <div id="typingIndicator"></div>
                    <div class="chat-input">
                        <form id="chatForm" class="d-flex gap-2">
                            <input type="text" class="form-control" id="messageInput"
                                placeholder="Type your message here..." autocomplete="off">
                            <button type="submit" class="btn btn-success px-4">Send</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Auth check
        const username = localStorage.getItem('username');
        if (!username) {
            window.location.href = 'login.html';
        }

        $('#welcomeUser').text(`Hello, ${username}`);
        $('#displayUsername').val(username);

        const socket = io();
        let currentRoom = null;
        let privateTarget = null;
        let typingTimeout;

        // Join room
        $('#joinRoomBtn').on('click', function() {
            const room = $('#roomSelect').val();
            currentRoom = room;
            socket.emit('joinRoom', { username, room });

            $('#roomSelection').hide();
            $('#chatArea').show();
            $('#currentRoom').text(room);
            $('#messages').empty();
        });

        // Leave room
        $('#leaveRoomBtn').on('click', function() {
            if (currentRoom) {
                socket.emit('leaveRoom', { username, room: currentRoom });
                currentRoom = null;
                privateTarget = null;
                $('#chatArea').hide();
                $('#roomSelection').show();
                $('#messages').empty();
                $('#membersList').empty();
            }
        });

        // Send message
        $('#chatForm').on('submit', function(e) {
            e.preventDefault();
            const message = $('#messageInput').val().trim();
            if (!message) return;

            const selectedUser = $('#privateUserSelect').val();
            if (selectedUser) {
                // Private message
                socket.emit('privateMessage', {
                    from_user: username,
                    to_user: selectedUser,
                    message
                });
            } else {
                // Group message
                socket.emit('chatMessage', { username, room: currentRoom, message });
            }

            socket.emit('stopTyping', { username, room: currentRoom });
            $('#messageInput').val('');
        });

        // Receive group message
        socket.on('message', function(data) {
            appendMessage(data);
        });

        // Receive private message
        socket.on('privateMessage', function(data) {
            appendMessage(data, true);
        });

        // Room history
        socket.on('roomHistory', function(messages) {
            messages.forEach(msg => appendMessage(msg));
        });

        // Room users update
        socket.on('roomUsers', function(users) {
            $('#membersList').empty();
            $('#privateUserSelect').empty().append('<option value="">Send to room (all)</option>');
            users.forEach(user => {
                $('#membersList').append(`<div class="member">${user}</div>`);
                if (user !== username) {
                    $('#privateUserSelect').append(`<option value="${user}">${user}</option>`);
                }
            });
        });

        // Typing indicator
        $('#messageInput').on('input', function() {
            socket.emit('typing', { username, room: currentRoom });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stopTyping', { username, room: currentRoom });
            }, 1000);
        });

        socket.on('typing', function(data) {
            $('#typingIndicator').text(`${data.username} is typing...`);
        });

        socket.on('stopTyping', function() {
            $('#typingIndicator').text('');
        });

        // Logout
        $('#logoutBtn').on('click', function() {
            if (currentRoom) {
                socket.emit('leaveRoom', { username, room: currentRoom });
            }
            localStorage.clear();
            window.location.href = 'login.html';
        });

        // Helper: append message to chat
        function appendMessage(data, isPrivate = false) {
            const time = new Date(data.date_sent).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isOwn = data.from_user === username;
            const isBot = data.from_user === 'Chat App Bot';

            let bubbleClass = 'message-bubble';
            if (isBot) bubbleClass += ' bot';
            else if (isPrivate) bubbleClass += ' private-msg';
            else if (isOwn) bubbleClass += ' own';

            const privateLabel = isPrivate ? `<span class="badge bg-warning text-dark">Private</span> ` : '';

            const html = `
                <div class="${bubbleClass}">
                    <div class="sender">${privateLabel}${data.from_user} <span class="time">${time}</span></div>
                    <div class="text">${escapeHtml(data.message)}</div>
                </div>
            `;

            $('#messages').append(html);
            $('#messages').scrollTop($('#messages')[0].scrollHeight);
        }

        // Prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
